function saveConfigFileSettings(){saveJSONConfig(scriptList.Pages[currentPage].ID,scriptList.Pages[currentPage].FileName,configData[workCfg],null)}function upgradeJSONVersion(a){var b=a.Version;if(console.log(b),b!=jsonFileVersion){if(isNaN(b)||(b=void 0)){console.log("upgrade from noversion to 1.1.1");for(var c=0;c<a.Buttons.length;c++)void 0==a.Buttons[c].EventMask&&(a.Buttons[c].EventMask=31);a.Version="1.1.1"}"1.1.1"==a.Version&&(console.log("upgrading to 1.1.2"),a.MQTT={Subscribe:[{Topic:"BTNASK",InclAddr:!1}],Publish:[{Topic:"BTNREPORT",InclAddr:!1},{Topic:"BTNREPLY",InclAddr:!1}]},a.Version="1.1.2"),"1.1.2"==a.Version&&(console.log("upgrading to 1.1.3"),a.RefreshInterval=3e4,a.Sensitivity=2,a.Version="1.1.3")}}function setThreshold(a){if("holdthreshold"==a.id&&(configData[2].HoldThreshold=verifyNumber(a.value,configData[2].HoldThreshold)),"dblclkthreshold"==a.id&&(configData[2].DblClickThreshold=verifyNumber(a.value,configData[2].DblClickThreshold)),"analogrefresh"==a.id&&(configData[2].RefreshInterval=verifyNumber(a.value,configData[2].RefreshInterval)),"analogsensitivity"==a.id&&(configData[2].Sensitivity=verifyNumber(a.value,configData[2].Sensitivity)),"baseaddress"==a.id&&(configData[2].BoardBaseAddr=verifyNumber(a.value,configData[2].BoardBaseAddr),1==confirm("Set all Button Addresses?")))for(var b=0;b<configData[2].Buttons.length;b++){configData[2].Buttons[b].ButtonAddr=configData[2].BoardBaseAddr+b;var c=document.getElementById(buttonTable.id+"_"+b.toString()+"_3");c.childNodes[0].value=configData[2].Buttons[b].ButtonAddr}"mqbtnask"==a.id&&(configData[2].MQTT.Subscribe[0].Topic=a.value),"inclbtnask"==a.id&&(configData[2].MQTT.Subscribe[0].InclAddr=a.checked),"mqbtnreport"==a.id&&(configData[2].MQTT.Publish[0].Topic=a.value),"inclbtnreport"==a.id&&(configData[2].MQTT.Publish[0].InclAddr=a.checked),"mqbtnreply"==a.id&&(configData[2].MQTT.Publish[1].Topic=a.value),"inclbtnreply"==a.id&&(configData[2].MQTT.Publish[1].InclAddr=a.checked)}function downloadSettings(){downloadConfig(256)}function setButtonData(a){var b=parseInt(a.getAttribute("col")),c=parseInt(a.getAttribute("row"));switch(b){case 2:configData[2].Buttons[c].ButtonType=btnStatus[a.selectedIndex];break;case 3:configData[2].Buttons[c].ButtonAddr=verifyNumber(a.value,configData[2].Buttons[c].ButtonAddr);break;case 5:var d=parseInt(a.getAttribute("index"));a.checked?configData[2].Buttons[c].EventMask|=1<<d:configData[2].Buttons[c].EventMask&=~(1<<d),0==(31&configData[2].Buttons[c].EventMask)?configData[2].Buttons[c].EventMask=32:configData[2].Buttons[c].EventMask&=31}}function tfThrottleEvtMask(a,b,c,d){function e(c,e,f){var g="eventmask_"+a.toString()+"_"+b.toString()+"_"+e.toString(),h=tfCheckBox(a,b,g,d);return h.childNodes[0].setAttribute("index",e),h.childNodes[1].innerHTML=f,c.append(h),h}var f=document.createElement("div");return f.setAttribute("class","eventmask"),tfSetCoordinate(f,a,b,0,c),e(f,0,"Bi-stable Switch"),e(f,1,"Push Button"),f}function loadTableData(a,b){function i(a){return a==b[h].ButtonType}for(;b.length>maxButtons;)b.pop();for(;b.length<maxButtons;){var c={PortNr:0,ButtonType:"off",ButtonAddr:0,EventMask:31};c.PortNr=b.length,b.push(c)}var d=document.getElementById(buttonTable.id+"_head"),g=(document.getElementById(buttonTable.id+"_body"),d.childNodes[0].children.length,[0,26,26]);createDataTableLines(a,[tfPos,tfText,tfText,tfNumeric,tfText,tfBtnEvtMask],b.length,"setButtonData(this)");for(var h=0;h<b.length;h++){var j=g[h],k=document.getElementById(a.id+"_"+h.toString()+"_1");writeTextField(k.id,"Pin "+j.toString());var k=document.getElementById(a.id+"_"+h.toString()+"_2");writeTextField(k.id,b[h].ButtonType);var k=document.getElementById(a.id+"_"+h.toString()+"_3");k.childNodes[0].value=b[h].ButtonAddr;var k=document.getElementById(a.id+"_"+h.toString()+"_4");writeTextField(k.id,"");for(var k=document.getElementById(a.id+"_"+h.toString()+"_5"),l=1,m=0;m<5;m++){var n=document.getElementById("eventmask_"+h.toString()+"_5_"+m.toString());setVisibility(2!=btnStatus.findIndex(i),n.parentElement),n.checked=(b[h].EventMask&l<<m)>0}}}function setButtonStatus(a,b,c,d){var e=document.getElementById(buttonTable.id+"_"+b.toString()+"_4");switch(a){case 0:switch(d){case 0:writeTextField(e.id,"Btn Down"),e.style.backgroundColor="hsl(39, 50%, 50%)";break;case 1:writeTextField(e.id,"Btn Up"),e.style.backgroundColor="hsl(116, 100%, 22%)";break;case 2:writeTextField(e.id,"Btn Click"),e.style.backgroundColor="hsl(116, 100%, 50%)";break;case 3:writeTextField(e.id,"Btn Hold"),e.style.backgroundColor="hsl(0, 50%, 50%)";break;case 4:writeTextField(e.id,"Btn Dbl Click"),e.style.backgroundColor="hsl(240, 50%, 50%)";break;default:writeTextField(e.id,"Unkown Status"),e.style.backgroundColor="hsl(0, 0%, 50%)"}break;case 1:writeTextField(e.id,"Analog "+d.toString());var f=Math.round(240*(1-d/4096));e.style.backgroundColor="hsl("+f.toString()+", 100%, 50%)"}}function constructPageContent(a){var b;mainScrollBox=createEmptyDiv(a,"div","pagetopicboxscroll-y","btnconfigdiv"),createPageTitle(mainScrollBox,"div","tile-1","","h1","Smart Throttle Setup"),createPageTitle(mainScrollBox,"div","tile-1","","h2","Basic Settings"),b=createEmptyDiv(mainScrollBox,"div","tile-1",""),createTextInput(b,"tile-1_4","Analog Refresh (ms)","n/a","analogrefresh","setThreshold(this)"),createTextInput(b,"tile-1_4","Analog Sensitivity (%)","n/a","analogsensitivity","setThreshold(this)"),mqttTitle=createPageTitle(mainScrollBox,"div","tile-1","","h2","MQTT Settings"),mqttBox=createEmptyDiv(mainScrollBox,"div","tile-1",""),b=createEmptyDiv(mqttBox,"div","tile-1",""),createTextInput(b,"tile-1_4","(S) Btn Query. Topic:","n/a","mqbtnask","setThreshold(this)"),createCheckbox(b,"tile-1_4","Include Btn #","inclbtnask","setThreshold(this)"),b=createEmptyDiv(mqttBox,"div","tile-1",""),createTextInput(b,"tile-1_4","(P) Btn Status Topic:","n/a","mqbtnreport","setThreshold(this)"),createCheckbox(b,"tile-1_4","Include Btn #","inclbtnreport","setThreshold(this)"),b=createEmptyDiv(mqttBox,"div","tile-1",""),createTextInput(b,"tile-1_4","(P) Btn Reply Topic:","n/a","mqbtnreply","setThreshold(this)"),createCheckbox(b,"tile-1_4","Include Btn #","inclbtnreply","setThreshold(this)"),createPageTitle(mainScrollBox,"div","tile-1","","h2","Throttle Input Configuration"),buttonTable=createDataTable(mainScrollBox,"tile-1",["Pos","Stick Pin#","Input Type","LN Button Address","Input Status","Message Type"],"btnconfig",""),b=createEmptyDiv(mainScrollBox,"div","tile-1",""),createButton(b,"","Save & Restart","btnSave","saveSettings(this)"),createButton(b,"","Cancel","btnCancel","cancelSettings(this)"),b=createEmptyDiv(mainScrollBox,"div","tile-1",""),createButton(b,"","Save to File","btnDownload","downloadSettings(this)")}function loadNodeDataFields(a){maxButtons=3;var b=a.InterfaceTypeList[a.InterfaceIndex].Type;setVisibility(3==b,mqttTitle),setVisibility(3==b,mqttBox)}function loadDataFields(a){upgradeJSONVersion(a),writeInputField("analogrefresh",a.RefreshInterval),writeInputField("analogsensitivity",a.Sensitivity),writeInputField("mqbtnask",a.MQTT.Subscribe[0].Topic),writeCBInputField("inclbtnask",a.MQTT.Subscribe[0].InclAddr),writeInputField("mqbtnreport",a.MQTT.Publish[0].Topic),writeCBInputField("inclbtnreport",a.MQTT.Publish[0].InclAddr),writeInputField("mqbtnreply",a.MQTT.Publish[1].Topic),writeCBInputField("inclbtnreply",a.MQTT.Publish[1].InclAddr),loadTableData(buttonTable,a.Buttons)}function processLocoNetInput(a){setButtonStatus(a[0],a[1],a[2],a[3])}var mainScrollBox,buttonTable,mqttTitle,mqttBox;jsonFileVersion="1.1.3";var maxButtons=0,btnStatus=["off","digital","analog"];
