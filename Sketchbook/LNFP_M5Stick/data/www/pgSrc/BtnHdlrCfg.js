function saveConfigFileSettings(){saveJSONConfig(scriptList.Pages[currentPage].ID,scriptList.Pages[currentPage].FileName,configData[workCfg],prepareFileSeqBtnEvt)}function upgradeJSONVersion(a){return upgradeJSONVersionBtnHdlr(a)}function addFileSeq(a,b){addFileSeqBtnHdlr(a,b)}function clearDisplay(){for(var a=document.getElementById(buttonTable.id+"_body");a.hasChildNodes();)a.removeChild(a.childNodes[0])}function downloadSettings(){downloadConfig(64)}function setAddr2Disp(a,b,c){var e=document.getElementById("parambox_"+c.toString()+"_1"),f=document.getElementById("address2box_"+c.toString()+"_1"),g=document.getElementById("paramtext_"+c.toString()+"_1"),h=document.getElementById("btn_add_"+c.toString()+"_1"),i=document.getElementById("btn_cancel_"+c.toString()+"_1"),j=sourceOptionArray.indexOf(configData[workCfg].ButtonHandler[c].EventSource),k=!1;switch(setVisibility(!1,h),setVisibility(!1,i),a){case 0:break;case 1:break;case 2:k=!0,setVisibility(!0,h),setVisibility(!0,i),g.innerHTML="Value:&nbsp;";break;case 3:k=[0,3].indexOf(b)>=0,g.innerHTML="2 Btn. Hold Addr.:&nbsp;";break;case 4:k=[1,2].indexOf(b)>=0,g.innerHTML="Value:&nbsp;";break;case 5:break;case 6:k=!0,g.innerHTML="Locos:&nbsp;";break;case 7:k=!1}k?(setVisibility(!0,e),f.value=[3,4,6].indexOf(j)>=0?Array.isArray(configData[workCfg].ButtonHandler[c].CondData)?configData[workCfg].ButtonHandler[c].CondData:"":isNaN(configData[workCfg].ButtonHandler[c].CtrlCmd[configData[workCfg].ButtonHandler[c].CurrDisp].BtnCondAddr)?"":65535==configData[workCfg].ButtonHandler[c].CtrlCmd[configData[workCfg].ButtonHandler[c].CurrDisp].BtnCondAddr?"":configData[workCfg].ButtonHandler[c].CtrlCmd[configData[workCfg].ButtonHandler[c].CurrDisp].BtnCondAddr):setVisibility(!1,e)}function adjustEventList(a,b){for(;a.CtrlCmd.length>b;)a.CtrlCmd.splice(a.CtrlCmd.length-1,1);for(;a.CtrlCmd.length<b;)a.CtrlCmd.push(JSON.parse(JSON.stringify(newEventTemplate)))}function adjustSourceSelector(a,b,c){var d=document.getElementById("evttypebox_"+b.toString()+"_"+c.toString()),e=document.getElementById("cmdlistbox_"+b.toString()+"_"+c.toString());d.selectedIndex=sourceOptionArray.indexOf(a[b].EventSource);var f=a[b].ButtonNr.length,g=[],h=a[b].CurrDisp;switch(d.selectedIndex){case 0:for(var i=0;i<Math.pow(2,f);i++){for(var j="",k=0;k<f;k++)j+=(1<<k&i)>0?a[b].ButtonNr[k].toString()+" Cl ":a[b].ButtonNr[k].toString()+" Th ";g.push(j)}createOptions(e,g);break;case 1:for(var i=0;i<f;i++)g.push(a[b].ButtonNr[i].toString()+" Th "),g.push(a[b].ButtonNr[i].toString()+" Cl ");createOptions(e,g);break;case 2:var l=a[b].CtrlCmd.length;if(l>0)for(var i=0;i<l;i++)g.push(void 0!=a[b].CtrlCmd[i].BtnCondAddr?65535!=a[b].CtrlCmd[i].BtnCondAddr?"Aspect "+a[b].CtrlCmd[i].BtnCondAddr.toString():"Aspect #"+i.toString():"Aspect #"+i.toString());else g.push("Aspect");createOptions(e,g);break;case 3:createOptions(e,buttonValDispType);break;case 4:createOptions(e,["== 0","<",">=","== max"]);break;case 5:for(var i=0;i<Math.pow(2,f);i++){for(var j="",k=0;k<f;k++)j+=(1<<k&i)>0?a[b].ButtonNr[k].toString()+" Oc ":a[b].ButtonNr[k].toString()+" Fr ";g.push(j)}createOptions(e,g);break;case 6:createOptions(e,transponderValDispType);break;case 7:createOptions(e,powerValDispType)}h>=e.options.length&&(h=0),adjustEventList(a[b],e.options.length),e.selectedIndex=h,a[b].CurrDisp=h,setAddr2Disp(d.selectedIndex,h,b,c)}function setButtonData(a){var e,b=parseInt(a.getAttribute("row")),c=parseInt(a.getAttribute("col")),d=parseInt(a.getAttribute("index"));switch(c){case-1:e=configData[2].ButtonHandler.push(JSON.parse(JSON.stringify(newButtonTemplate))),adjustEventList(configData[2].ButtonHandler[e-1],5),loadTableData(buttonTable,configData[2].ButtonHandler);break;case 1:{var g;a.id}switch(d){case 1:event.ctrlKey?configData[2].ButtonHandler.splice(b+1,0,JSON.parse(JSON.stringify(configData[2].ButtonHandler[b]))):configData[2].ButtonHandler.splice(b+1,0,JSON.parse(JSON.stringify(newButtonTemplate)));break;case 2:configData[2].ButtonHandler.splice(b,1);break;case 3:b>0&&(g=configData[2].ButtonHandler.splice(b,1),configData[2].ButtonHandler.splice(b-1,0,g[0]));break;case 4:b<configData[2].ButtonHandler.length&&(g=configData[2].ButtonHandler.splice(b,1),configData[2].ButtonHandler.splice(b+1,0,g[0]));break;case 11:configData[workCfg].ButtonHandler[b].EventSource=sourceOptionArray[a.selectedIndex],adjustSourceSelector(configData[workCfg].ButtonHandler,b,c),buildCmdLines(b,configData[workCfg].ButtonHandler[b]);break;case 12:var h=verifyNumArray(a.value,","),i=sourceOptionArray.indexOf(configData[workCfg].ButtonHandler[b].EventSource);if([0,1,5].indexOf(i)>=0)for(;h.length>3;)h.pop();else for(;h.length>1;)h.pop();configData[workCfg].ButtonHandler[b].ButtonNr=h,a.value=h,adjustSourceSelector(configData[workCfg].ButtonHandler,b,c);break;case 13:configData[workCfg].ButtonHandler[b].CurrDisp=a.selectedIndex,buildCmdLines(b,configData[2].ButtonHandler[b]),setAddr2Disp(sourceOptionArray.indexOf(configData[workCfg].ButtonHandler[b].EventSource),a.selectedIndex,b,c);break;case 14:var i=sourceOptionArray.indexOf(configData[workCfg].ButtonHandler[b].EventSource),h=verifyNumArray(a.value,",");if([2,3,4].indexOf(i)>=0)for(;h.length>1;)h.pop();switch(i){case 2:configData[workCfg].ButtonHandler[b].CtrlCmd[configData[workCfg].ButtonHandler[b].CurrDisp].BtnCondAddr=isNaN(h)?[]:h;var j=document.getElementById("cmdlistbox_"+b.toString()+"_"+c.toString());j.options[j.selectedIndex].text="Aspect "+configData[workCfg].ButtonHandler[b].CtrlCmd[configData[workCfg].ButtonHandler[b].CurrDisp].BtnCondAddr.toString();break;case 3:case 4:case 6:configData[workCfg].ButtonHandler[b].CondData=h}a.value=h;break;case 15:configData[workCfg].ButtonHandler[b].CtrlCmd.splice(configData[workCfg].ButtonHandler[b].CurrDisp,0,JSON.parse(JSON.stringify(newEventTemplate))),loadTableData(buttonTable,configData[workCfg].ButtonHandler);break;case 16:if(configData[workCfg].ButtonHandler[b].CtrlCmd.length>0){if(configData[workCfg].ButtonHandler[b].CtrlCmd.splice(configData[workCfg].ButtonHandler[b].CurrDisp,1),configData[workCfg].ButtonHandler[b].CurrDisp>configData[workCfg].ButtonHandler[b].CtrlCmd.length-1){configData[workCfg].ButtonHandler[b].CurrDisp=configData[workCfg].ButtonHandler[b].CtrlCmd.length-1;var k=document.getElementById("cmdlistbox_"+b.toString()+"_"+c.toString());k.selectedIndex-=1}loadTableData(buttonTable,configData[workCfg].ButtonHandler)}}d<5&&loadTableData(buttonTable,configData[workCfg].ButtonHandler)}}function setCommandData(a){var b=parseInt(a.getAttribute("row")),c=parseInt(a.getAttribute("col")),d=parseInt(a.getAttribute("index")),e=configData[2].ButtonHandler[b].CurrDisp,f=parseInt(a.getAttribute("cmdline"));switch(isNaN(f)&&(f=parseInt(a.parentElement.getAttribute("cmdline"))),c){case-1:configData[2].ButtonHandler[b].CtrlCmd[e].CmdList.push(JSON.parse(JSON.stringify(newCmdTemplate))),buildCmdLines(b,configData[2].ButtonHandler[b]);break;case 1:switch(d){case 1:event.ctrlKey?configData[2].ButtonHandler[b].CtrlCmd[e].CmdList.splice(f+1,0,JSON.parse(JSON.stringify(configData[2].ButtonHandler[b].CtrlCmd[e].CmdList[f]))):configData[2].ButtonHandler[b].CtrlCmd[e].CmdList.splice(f+1,0,JSON.parse(JSON.stringify(newCmdTemplate)));break;case 2:configData[2].ButtonHandler[b].CtrlCmd[e].CmdList.splice(f,1);break;case 3:f>0&&(thisElement=configData[2].ButtonHandler[b].CtrlCmd[e].CmdList.splice(f,1),configData[2].ButtonHandler[b].CtrlCmd[e].CmdList.splice(f-1,0,thisElement[0]));break;case 4:f<configData[2].ButtonHandler[b].CtrlCmd[e].CmdList.length&&(thisElement=configData[2].ButtonHandler[b].CtrlCmd[e].CmdList.splice(f,1),configData[2].ButtonHandler[b].CtrlCmd[e].CmdList.splice(f+1,0,thisElement[0]))}buildCmdLines(b,configData[2].ButtonHandler[b]);break;case 2:var g=configData[2].ButtonHandler[b].CtrlCmd[e].CmdList[f].CtrlTarget;if(configData[2].ButtonHandler[b].CtrlCmd[e].CmdList[f].CtrlTarget=cmdOptions[a.selectedIndex],g!=configData[2].ButtonHandler[b].CtrlCmd[e].CmdList[f].CtrlTarget)switch(configData[2].ButtonHandler[b].CtrlCmd[e].CmdList[f].CtrlAddr=0,configData[2].ButtonHandler[b].CtrlCmd[e].CmdList[f].ExecDelay=250,a.selectedIndex){case 0:configData[2].ButtonHandler[b].CtrlCmd[e].CmdList[f].CtrlTarget="switch",configData[2].ButtonHandler[b].CtrlCmd[e].CmdList[f].CtrlType="toggle",configData[2].ButtonHandler[b].CtrlCmd[e].CmdList[f].CtrlValue="on";break;case 1:configData[2].ButtonHandler[b].CtrlCmd[e].CmdList[f].CtrlTarget="signal",configData[2].ButtonHandler[b].CtrlCmd[e].CmdList[f].CtrlType="aspect",configData[2].ButtonHandler[b].CtrlCmd[e].CmdList[f].CtrlValue="0";break;case 2:configData[2].ButtonHandler[b].CtrlCmd[e].CmdList[f].CtrlTarget="button",configData[2].ButtonHandler[b].CtrlCmd[e].CmdList[f].CtrlType="btndown",configData[2].ButtonHandler[b].CtrlCmd[e].CmdList[f].CtrlValue="0";break;case 3:configData[2].ButtonHandler[b].CtrlCmd[e].CmdList[f].CtrlTarget="analog",configData[2].ButtonHandler[b].CtrlCmd[e].CmdList[f].CtrlType="value",configData[2].ButtonHandler[b].CtrlCmd[e].CmdList[f].CtrlValue="0";break;case 4:configData[2].ButtonHandler[b].CtrlCmd[e].CmdList[f].CtrlTarget="block",configData[2].ButtonHandler[b].CtrlCmd[e].CmdList[f].CtrlType="block",configData[2].ButtonHandler[b].CtrlCmd[e].CmdList[f].CtrlValue="on";break;case 5:configData[2].ButtonHandler[b].CtrlCmd[e].CmdList[f].CtrlTarget="power",configData[2].ButtonHandler[b].CtrlCmd[e].CmdList[f].CtrlType="idle",configData[2].ButtonHandler[b].CtrlCmd[e].CmdList[f].CtrlValue="0"}buildCmdLines(b,configData[2].ButtonHandler[b]);break;case 3:configData[2].ButtonHandler[b].CtrlCmd[e].CmdList[f].CtrlAddr=verifyNumber(a.value,configData[2].ButtonHandler[b].CtrlCmd[e].CmdList[f].CtrlAddr);break;case 4:configData[2].ButtonHandler[b].CtrlCmd[e].CmdList[f].ExecDelay=verifyNumber(a.value,configData[2].ButtonHandler[b].CtrlCmd[e].CmdList[f].ExecDelay);break;case 5:switch(configData[2].ButtonHandler[b].CtrlCmd[e].CmdList[f].CtrlTarget){case"switch":configData[2].ButtonHandler[b].CtrlCmd[e].CmdList[f].CtrlType=swiCmdOptions[a.selectedIndex];break;case"block":configData[2].ButtonHandler[b].CtrlCmd[e].CmdList[f].CtrlType=swiPwrOptions[a.selectedIndex];break;case"power":configData[2].ButtonHandler[b].CtrlCmd[e].CmdList[f].CtrlType=trackPwrOptions[a.selectedIndex];break;case"button":configData[2].ButtonHandler[b].CtrlCmd[e].CmdList[f].CtrlType=buttonOptions[a.selectedIndex]}break;case 6:switch(configData[2].ButtonHandler[b].CtrlCmd[e].CmdList[f].CtrlTarget){case"switch":configData[2].ButtonHandler[b].CtrlCmd[e].CmdList[f].CtrlValue=swiPwrOptions[a.selectedIndex];break;case"block":configData[2].ButtonHandler[b].CtrlCmd[e].CmdList[f].CtrlValue=swiPwrOptions[a.selectedIndex];break;case"signal":configData[2].ButtonHandler[b].CtrlCmd[e].CmdList[f].CtrlValue=verifyNumber(a.value,configData[2].ButtonHandler[b].CtrlCmd[e].CmdList[f].CtrlValue);break;case"analog":var h=(parseInt(configData[2].ButtonHandler[b].CtrlCmd[e].CmdList[f].CtrlType)<<8)+parseInt(configData[2].ButtonHandler[b].CtrlCmd[e].CmdList[f].CtrlValue),i=4095&verifyNumber(a.value,h);configData[2].ButtonHandler[b].CtrlCmd[e].CmdList[f].CtrlType=((3840&i)>>8).toString(),configData[2].ButtonHandler[b].CtrlCmd[e].CmdList[f].CtrlValue=(255&i).toString()}}}function buildCmdLines(a,b){for(var c=document.getElementById("btnconfig_inp_"+a.toString()+"_2");c.hasChildNodes();)c.removeChild(c.childNodes[0]);if(b.CtrlCmd.length>0&&b.CtrlCmd[b.CurrDisp].CmdList.length>0)for(var d=0;d<b.CtrlCmd[b.CurrDisp].CmdList.length;d++){var e=document.createElement("div");e.setAttribute("class","mastertile"),e.style.backgroundColor=d%2==0?"#F5F5F5":"#D3D3D3",tfSetCoordinate(e,d,0,0,f),c.append(e);var f="pos_"+a.toString()+"_"+d.toString();e.append(tfPos(d,-1,f,"")),f="cmdbasedata_"+a.toString()+"_"+d.toString();var g=document.createElement("div");g.setAttribute("class","editortile"),tfSetCoordinate(g,d,0,0,f),e.append(g);var h=document.createElement("div");h.setAttribute("class","editorpanel"),f="cmdmanipulator_"+a.toString()+"_"+d.toString();var i=tfManipulatorBox(a,1,f,"setCommandData(this)");i.setAttribute("cmdline",d),h.append(i),f="cmdlineheader_"+a.toString()+"_"+d.toString(),h.append(tfCmdEvtLineHeader(a,d,f,"setCommandData(this)",b.CtrlCmd[b.CurrDisp].CmdList[d])),g.append(h);var j=document.createElement("div");switch(j.setAttribute("class","editorpanel"),g.append(j),b.CtrlCmd[b.CurrDisp].CmdList[d].CtrlTarget){case"switch":j.append(setSwitchEditor(a,d,f,"setCommandData(this)",b.CtrlCmd[b.CurrDisp].CmdList[d]));break;case"signal":j.append(setSignalEditor(a,d,f,"setCommandData(this)",b.CtrlCmd[b.CurrDisp].CmdList[d]));break;case"button":j.append(setButtonEditor(a,d,f,"setCommandData(this)",b.CtrlCmd[b.CurrDisp].CmdList[d]));break;case"analog":j.append(setAnalogEditor(a,d,f,"setCommandData(this)",b.CtrlCmd[b.CurrDisp].CmdList[d]));break;case"power":j.append(setPowerEditor(a,d,f,"setCommandData(this)",b.CtrlCmd[b.CurrDisp].CmdList[d]));break;case"block":j.append(setBlockDetEditor(a,d,f,"setCommandData(this)",b.CtrlCmd[b.CurrDisp].CmdList[d]))}}else{var g=document.createElement("div");g.setAttribute("class","editortile"),tfSetCoordinate(g,d,0,0,f),c.append(g);var k="cmdbasedata_initadd"+a.toString(),l=tfTableStarterBox(a,-1,k,"setCommandData(this)");g.append(l)}}function loadTableData(a,b){{var c=document.getElementById(a.id+"_head");document.getElementById(a.id+"_body"),c.childNodes[0].children.length}createDataTableLines(a,[tfPos,tfCommandEvtSelector,tfCommandEditor],b.length,"setButtonData(this)");for(var f=0;f<b.length;f++){var g=document.getElementById("addressbox_"+f.toString()+"_1");g.value=b[f].ButtonNr,isNaN(b[f].CurrDisp)&&(b[f].CurrDisp=0);var h=document.getElementById("evttypebox_"+f.toString()+"_1");h.selectedIndex=-1;for(var i=0;i<h.options.length;i++)if(h.options[i].text==b[f].EventSource){h.selectedIndex=i;break}var j=document.getElementById("cmdlistbox_"+f.toString()+"_1");adjustSourceSelector(configData[workCfg].ButtonHandler,f,1),j.selectedIndex=b[f].CurrDisp,buildCmdLines(f,b[f])}}function loadNodeDataFields(){}function constructPageContent(a){var b;mainScrollBox=createEmptyDiv(a,"div","pagetopicboxscroll-y","nodeconfigdiv"),createPageTitle(mainScrollBox,"div","tile-1","BasicCfg_Title","h1","LocoNet Event Handler Setup"),buttonTable=createDataTable(mainScrollBox,"tile-1",["Pos","IF THIS: (Input Event Selector)","THEN THAT: (Event Command Sequence)"],"btnconfig",""),b=createEmptyDiv(mainScrollBox,"div","tile-1",""),createButton(b,"","Save & Restart","btnSave","saveSettings(this)"),createButton(b,"","Cancel","btnCancel","cancelSettings(this)"),b=createEmptyDiv(mainScrollBox,"div","tile-1",""),createButton(b,"","Save to File","btnDownload","downloadSettings(this)")}function loadDataFields(a){configData[workCfg]=upgradeJSONVersion(a),loadTableData(buttonTable,configData[workCfg].ButtonHandler)}function processLocoNetInput(){}var mainScrollBox,buttonTable,sourceOptionArray=["switch","dynsignal","dccsignal","button","analogvalue","blockdetector","transponder","power"],newEventTemplate={BtnCondAddr:[],CmdList:[]},newButtonTemplate={EventSource:"button",CondData:[],ButtonNr:0,CtrlCmd:[]},newCmdTemplate={CtrlTarget:"switch",CtrlAddr:0,CtrlType:"toggle",CtrlValue:"on",ExecDelay:250},cmdOptions=["switch","signal","button","analog","block","power"],swiCmdOptions=["thrown","closed","toggle"],swiPwrOptions=["on","off"],trackPwrOptions=["on","off","idle","toggle"],buttonOptions=["btndown","btnup","btnclick","btnhold","btndblclick"],buttonValDispType=["Btn Down","Btn Up","Btn Click","Btn Hold","Btn Dbl Click"],powerValDispType=["Off","On","Idle"],transponderValDispType=["Enter","Leave"];jsonFileVersion="1.3.0";
