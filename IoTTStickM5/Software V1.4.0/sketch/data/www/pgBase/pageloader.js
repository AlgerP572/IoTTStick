function loadPageList(a,b,c,d){var e=new XMLHttpRequest;e.onreadystatechange=function(){if(4==this.readyState&&200==this.status){for(scriptList=JSON.parse(this.response),i=0;i<scriptList.Pages.length;i++)scriptList.Pages[i].WebPage==a?(currentPage=i,createMenueTabElement(b,"button","tablink",scriptList.Pages[i].ID,scriptList.Pages[i].Menue,!0,"")):createMenueTabElement(b,"button","tablink",scriptList.Pages[i].ID,scriptList.Pages[i].Menue,!1,"loadPage('"+scriptList.Pages[i].WebPage+"')");updateMenueTabs(scriptList.Pages[currentPage].ID,"grey"),constructPageContent(c),constructFooterContent(d)}},e.open("GET","pageconfig.json",!0),e.setRequestHeader("Cache-Control","no-cache"),e.send()}function updateMenueTabs(a,b){for(tablinks=document.getElementsByClassName("tablink"),i=0;i<tablinks.length;i++)tablinks[i].style.backgroundColor=tablinks[i].id==a?b:""}function setLEDTestDisplay(a){ws.send('{"Cmd":"SetLED", "LedNr":['+a+"]}")}function setServoPos(a,b){ws.send('{"Cmd":"SetServo", "ServoNr":['+a+'], "ServoPos":'+b+"}")}function downloadConfig(a){ws.send('{"Cmd":"CfgFiles", "Type":'+a+"}")}function showMenueTabs(a){for(i=0;i<scriptList.Pages.length;i++){var b=!1,c=document.getElementById(scriptList.Pages[i].ID);(scriptList.Pages[i].ProdSel.indexOf(-1)>=0||scriptList.Pages[i].CommSel.indexOf(-1)>=0)&&(b=!0);var d=parseInt(a.HatTypeList[a.HatIndex].HatId);scriptList.Pages[i].ProdSel.indexOf(d)>=0&&(b=!0),d=parseInt(a.InterfaceTypeList[a.InterfaceIndex].IntfId),scriptList.Pages[i].CommSel.indexOf(d)>=0&&(b=!0);for(var e=0;e<a.ALMIndex.length;e++)scriptList.Pages[i].ALMSel.indexOf(a.ALMIndex[e])>=0&&(b=!0);setVisibility(b,c)}}function loadPage(a){window.location.href=a}function sendFileData(a,b,c,d,e){var f='{"Cmd":"CfgUpdate", "FileNameType": "'+b+'", "FileName": "'+c+'", "Restart": '+e+', "Type":"'+a+'", "Data":'+d+"}";ws.send(f),console.log(JSON.parse(f))}function sendDeleteFile(a,b,c,d){var e='{"Cmd":"CfgUpdate", "FileNameType": "'+b+'", "FileName": "'+c+'", "Type":"'+a+'", "Index":'+d+"}";ws.send(e),console.log(JSON.parse(e))}function startProgressDialog(a){var b=document.createElement("div");b.setAttribute("class","modal");var c=document.createElement("div");c.setAttribute("class","modal-content"),b.append(c);var d=document.createElement("div");d.setAttribute("class","modal-header"),c.append(d);var e=document.createElement("span");e.setAttribute("class","close"),e.innerHTML="&times;",d.append(e);var f=document.createElement("h2");f.innerHTML="Please wait... Configuration files are being transferred.",d.append(f),d=document.createElement("div"),d.setAttribute("class","modal-body"),c.append(d),dlgTextDispArea=document.createElement("textarea"),dlgTextDispArea.setAttribute("readonly","true"),dlgTextDispArea.setAttribute("rows",10),dlgTextDispArea.setAttribute("style","width:100%"),d.append(dlgTextDispArea),d=document.createElement("div"),d.setAttribute("class","modal-footer"),c.append(d);var f=document.createElement("h3");f.innerHTML="Thank you for using the IoTT Stick!",d.append(f),a.append(b);var g=document.getElementsByClassName("close");return g[0].onclick=function(){progressDlg.style.display="none"},b}function closeDlg(){wsInitNode=!0,wsInitData=!0,setTimeout(function(){startWebsockets()},2500),progressDlg&&(progressDlg.style.display="none")}function uploadConfig(a){function c(a){return a.ID==b}var b="";transferData=[];for(var d=0;d<a.length;d++){if(void 0==a[d].FileName){b=a[d].Type;var e=scriptList.Pages.findIndex(c);isNaN(e)||(a[d].FileName=scriptList.Pages[e].FileName+".cfg")}sendDeleteFile("pgDelete",a[d].FileNameType,a[d].FileName,0),transferData.push(JSON.parse(JSON.stringify(a[d])))}progressDlg&&(dlgTextDispArea.innerHTML=""),fileSendIndex=0,sendMultiFile()}function setCTS(){}function clearCTS(){}function sendSingleFile(){console.log("Create Single File Dlg ",fileGroupIndex,fileSendIndex),null==progressDlg&&(progressDlg=startProgressDialog(document.getElementById("TabHolder"))),progressDlg.style.display="block";var a=transferData[fileGroupIndex],b=a.FileName;fileSendIndex>0&&(b+=fileSendIndex.toString()),b+=".cfg";var c=fileGroupIndex==transferData.length-1&&fileSendIndex==a.FileList.length-1;sendFileData(a.Type,a.FileName,b,JSON.stringify(a.FileList[fileSendIndex]),c),clearCTS(),dlgTextDispArea.innerHTML+="Send file "+b+" to IoTT Stick\n",fileSendIndex++,fileSendIndex<a.FileList.length?setTimeout(function(){sendSingleFile()},4e3):(fileGroupIndex++,fileGroupIndex<transferData.length?(fileSendIndex=0,setTimeout(function(){sendSingleFile()},4e3)):("function"==typeof clearDisplay&&clearDisplay(),setTimeout(function(){closeDlg()},4e3)))}function sendMultiFile(){null==progressDlg&&(progressDlg=startProgressDialog(document.getElementById("TabHolder"))),progressDlg.style.display="block",dlgTextDispArea.innerHTML+="Send file "+transferData[fileSendIndex].FileName+" to IoTT Stick\n",sendFileData(transferData[fileSendIndex].Type,transferData[fileSendIndex].FileNameType,transferData[fileSendIndex].FileName,JSON.stringify(transferData[fileSendIndex].Data),fileSendIndex==transferData.length-1),fileSendIndex++,fileSendIndex<transferData.length?setTimeout(function(){sendMultiFile()},500):setTimeout(function(){closeDlg()},2500)}function saveJSONConfig(a,b,c,d){var e=transferData.push(JSON.parse(JSON.stringify({Type:"",FileName:"",FileNameType:"",FileList:[]})))-1;if(transferData[e].Type=a,transferData[e].FileName=b,transferData[e].FileNameType=b,"function"==typeof d)d(c,e),transferData[e].FileList.length>0&&sendDeleteFile("pgDelete",transferData[e].FileNameType,transferData[e].FileName,transferData[e].FileList.length);else{var f=JSON.parse(JSON.stringify(c));transferData[e].FileList.push(f)}}function saveSettings(){transferData=[],saveConfigFileSettings(),progressDlg&&(dlgTextDispArea.innerHTML=""),fileSendIndex=0,fileGroupIndex=0,console.log(transferData),sendSingleFile()}function cancelSettings(){configData[2]=JSON.parse(JSON.stringify(configData[1])),loadDataFields(configData[workCfg])}function loadInitData(){console.log("loadInitData"),wsInitNode?("pgNodeCfg"!=scriptList.Pages[currentPage].ID?(ws.send('{"Cmd":"CfgData", "Type":"pgNodeCfg", "FileName": "node"}'),console.log('{"Cmd":"CfgData", "Type":"pgNodeCfg", "FileName": "node"}')):wsInitNode=!1,setTimeout(loadInitData,1e3)):wsInitData&&(ws.send('{"Cmd":"CfgData", "Type":"'+scriptList.Pages[currentPage].ID+'", "FileName":"'+scriptList.Pages[currentPage].FileName+'"}'),console.log('{"Cmd":"CfgData", "Type":"'+scriptList.Pages[currentPage].ID+'", "FileName":"'+scriptList.Pages[currentPage].FileName+'"}'))}function startWebsockets(){ws=new WebSocket(serverIP),ws.onopen=function(){console.log("websock opening"),(wsInitData||wsInitNode)&&setTimeout(loadInitData,1e3)},ws.onclose=function(){console.log("websock close"),setTimeout(startWebsockets,3e3)},ws.onerror=function(a){console.log(a)},ws.onmessage=function(a){var b=JSON.parse(a.data);if("CTS"==b.Cmd&&setCTS(),"STATS"==b.Cmd&&processStatsData(b.Data),"HWBtn"==b.Cmd&&"pgHWBtnCfg"==scriptList.Pages[currentPage].ID&&processLocoNetInput(b.Data),"HWBtn"==b.Cmd&&"pgThrottleCfg"==scriptList.Pages[currentPage].ID&&processLocoNetInput(b.Data),"LN"==b.Cmd&&"pgLNViewer"==scriptList.Pages[currentPage].ID&&processLocoNetInput(b.Data),"OLCB"==b.Cmd&&"pgOLCBViewer"==scriptList.Pages[currentPage].ID&&processOLCBInput(b),"DCC"==b.Cmd&&"pgDCCViewer"==scriptList.Pages[currentPage].ID&&processDCCInput(b.Data),String(b.Cmd).indexOf("MQTT")>=0&&"pgMQTTViewer"==scriptList.Pages[currentPage].ID&&processMQTTInput(b),"CfgFiles"==b.Cmd)switch(b.FileMode){case 1:dlgTextDispArea.innerHTML+="Receive file "+b.FileName+" from IoTT Stick\n",transferData.push(JSON.parse(JSON.stringify(b)));break;case 2:transferData=[],null==progressDlg&&(progressDlg=startProgressDialog(document.getElementById("TabHolder"))),dlgTextDispArea.innerHTML="",progressDlg.style.display="block";break;case 3:progressDlg&&(progressDlg.style.display="none");var c=document.createElement("a");c.href=URL.createObjectURL(new Blob([JSON.stringify(transferData,null,2)],{type:"text/plain"})),c.setAttribute("download","M5Config.json"),document.body.appendChild(c),c.click(),document.body.removeChild(c)}"CfgData"==b.Cmd&&("pgNodeCfg"==b.Type&&(wsInitNode=!1,configData[nodeCfg]=JSON.parse(JSON.stringify(b.Data)),showMenueTabs(configData[nodeCfg]),loadNodeDataFields(configData[nodeCfg])),b.Type==scriptList.Pages[currentPage].ID?(b.ResetData?(wsInitData=!1,configData[loadCfg]=JSON.parse(JSON.stringify(b.Data)),configData[workCfg]=JSON.parse(JSON.stringify(b.Data))):"function"==typeof addFileSeq&&addFileSeq(b.Data,configData),loadDataFields(configData[workCfg])):"pgNodeCfg"!=b.Type&&"function"==typeof addDataFile&&addDataFile(b))}}var systemTime=new Date,serverIP="ws://"+location.hostname+"/ws",ws=null,scriptList,currentPage=0,wsInitNode=!0,wsInitData=!0,flagCTS=!0,ctsTimeout,transferDataObj={Type:"",FileName:"",FileNameType:"",FileList:[]},nodeCfg=0,loadCfg=1,workCfg=2,configData=[{},{},{}],transferData,progressDlg=null,dlgTextDispArea,fileGroupIndex=0,fileSendIndex=0,targetSize=10240;
